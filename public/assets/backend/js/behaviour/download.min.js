function FormatProgressBar(e){var a=parseInt(e);var o='<div class="progress"><div class="progress-bar" style="width: '+a+'%"></div></div>';return o}function FormatByte(e){App.formatBytes(e)}function StateIcon(e){var a,o;switch(e){case"Completed":a="ok-circle text-success";break;case"Running":a="play-circle text-info";break;case"Stopped":a="ban-circle text-warning";break;case"Failed":a="remove-circle text-danger";break;default:e="Stopped";a="ban-circle text-warning"}o=states[e];return'<span class="glyphicon glyphicon-'+a+'" title="'+o+'"></span>'}function FormatSpeedByte(e){return FormatByte(e)+"/s"}var downloadWS,downloadWSInterval,downloadAPIPrefix=BACKEND_URL+"/download";function connectSockJS(e,a){if(downloadWS){if(e!=null)e();return false}downloadWS=new SockJS(downloadAPIPrefix+"/progress");downloadWS.onopen=function(){if(e!=null)e()};downloadWS.onclose=function(){downloadWS=null};downloadWS.onmessage=function(e){if(a!=null)a(e.data)}}function closeSockJS(){if(downloadWSInterval){window.clearInterval(downloadWSInterval);downloadWSInterval=null}if(downloadWS){downloadWS.close();downloadWS=null}}function sockJSConnect(){var u=$("#tr-template").html();connectSockJS(function(){downloadWS.send("progress")},function(e){var a=JSON.parse(e);var o=100*a.length,n=0;var t="";var r=$("#fileTable .allCheck").prop("checked");for(var d=0;d<a.length;d++){var l=a[d];if(l.State!="Running"){n+=100}else{n+=l.Progress}if($("#id-"+l.Id).length>0){$("#downed-"+l.Id).text(FormatByte(l.Downloaded));$("#percent-"+l.Id).text(l.Progress);$("#speed-"+l.Id).text(FormatSpeedByte(l.Speed));$("#progress-"+l.Id).html(FormatProgressBar(l.Progress));$("#state-"+l.Id).html(StateIcon(l.State));continue}var c=u;for(var i in l){var s=new RegExp("\\{"+i+"\\}","g");var f=l[i];switch(i){case"Downloaded":f=FormatByte(f);break;case"Size":f=FormatByte(f);break;case"Speed":f=FormatSpeedByte(f);break;case"FileName":f='<span id="state-'+l.Id+'">'+StateIcon(l.State)+"</span> "+f;break;case"Progress":var p=new RegExp("\\{Percent\\}");c=c.replace(p,f);f=FormatProgressBar(f);break}c=c.replace(s,f)}if(r){c=$(c);c.find(".idCheck").prop("checked",true)}$("#fileList").append(c)}if(downloadWSInterval&&o<=n){closeSockJS()}})}function sockJSRead(){if(downloadWSInterval)return;if(!downloadWS){sockJSConnect()}else{downloadWS.send("progress")}downloadWSInterval=setInterval(function(){if(!downloadWS){window.clearInterval(downloadWSInterval);return}downloadWS.send("progress")},2e3)}function reqJSON(e,a,o){loading(false);var n={contentType:"application/json; charset=utf-8",url:downloadAPIPrefix+e,type:"POST",dataType:"json"};if(a)n.data=JSON.stringify(a);$.ajax(n).error(function(e){loading(true);alert(e)}).success(function(e){loading(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(o)o();sockJSRead()})}function reqForm(e,a,o){loading(false);var n={url:downloadAPIPrefix+e,type:"POST",dataType:"json"};if(a)n.data=a;$.ajax(n).error(function(e){loading(true);alert(e)}).success(function(e){loading(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(o)o();sockJSRead()})}function AddDownload(){var e={PartCount:parseInt($("#part_count_id").val()),FilePath:$("#save_path_id").val(),Url:$("#url_id").val()};reqJSON("/add_task",e)}function checkedIds(){var e=[];$("#fileTable .idCheck:checked").each(function(){e.push(parseInt($(this).val()))});return e}function RemoveDownload(){var a={id:checkedIds()};reqForm("/remove_task",a,function(){for(var e=0;e<a.id.length;e++){$("#id-"+a.id[e]).parent("tr").remove()}})}function StartDownload(){var e={id:checkedIds()};reqForm("/start_task",e)}function StopDownload(){var e={id:checkedIds()};reqForm("/stop_task",e)}function StartAllDownload(){reqJSON("/start_all_task")}function StopAllDownload(){reqJSON("/stop_all_task")}function OnChangeUrl(){var e=$("#url_id").val().split("/").pop();$("#save_path_id").val(e)}function loading(e){App.loading(e?"hide":"show")}$(function(){sockJSRead();$("body").on("click","#fileTable .allCheck",function(){$("#fileTable .idCheck").prop("checked",$(this).prop("checked"))})});