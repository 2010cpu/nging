if(typeof window.CropServerURL=="undefined"){window.CropServerURL=BACKEND_URL+"/manager/crop"}else{window.CropServerURL=window.CropServerURL||BACKEND_URL+"/manager/crop"}function cropImage(e,n,o,s,l,p){var d=null;if(!s){s=e.split("?",2)[0];s=s.substring(s.lastIndexOf("/")+1)}if(l==null)l=200;if(p==null)p=l;$("#fileupload").fileupload({url:e,dataType:"json",done:function(e,a){var i=a.result;if(i.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:i.Info,time:5e3,sticky:false,class_name:i.Code==1?"success":"error"})}var r=function(){d.destroy();$(".crop-image").empty();d=null};if(d)r();$.each(i.Data.files,function(e,a){$(o).val(a);$(".crop-image").html('<img src="'+a+"?_="+Math.random()+'" />');$("#progress").fadeOut();$("#save-image").data("image-file",a);var i=$(".crop-image img");i.Jcrop({aspectRatio:l/p,minSize:[l,p],setSelect:[0,0,l,p]},function(){d=this})});if(typeof $.fn.niftyModal!="undefined"){$("#crop-image").niftyModal("show",{afterClose:r})}else{$("#crop-image").modal("show");$("#crop-image").off("hide.bs.modal").on("hide.bs.modal",function(){r()})}},progressall:function(e,a){var i=parseInt(a.loaded/a.total*100,10);$("#progress").fadeIn();$("#progress").css("width",i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled");$("#save-image").on("click",function(){var t=$(this);App.getImgNaturalDimensions($(".crop-image img")[0],function(e){var a=$(".crop-image img");var i=d.tellSelect();if(i.w!=0){var r=e.w/a.width();var o=t.data("image-file");$.get(window.CropServerURL,{src:o,x:i.x*r,y:i.y*r,w:i.w*r,h:i.h*r,type:s,size:l+"x"+p},function(e){if(e.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:e.Info,time:5e3,sticky:false,class_name:e.Code==1?"success":"error"})}$(".profile-avatar").attr("src",e.Data+"?_="+Math.random());$(n).val(e.Data);if(typeof $.fn.niftyModal!="undefined"){$("#crop-image").niftyModal("hide")}else{$("#crop-image").modal("hide")}d.destroy();$(".crop-image").empty();d=null},"json")}else{alert("Please select a crop region then press save.")}})});$(".avatar-upload .avatar-remove").on("click",function(){$(".profile-avatar").attr("src","");$(o).val("");$(n).val("")})}