function getCropServerURL(){if(typeof window.CropServerURL!="undefined"&&window.CropServerURL){return window.CropServerURL}if(typeof window.IS_BACKEND!="undefined"&&window.IS_BACKEND){return BACKEND_URL+"/manager/crop"}return FRONTEND_URL+"/user/file/crop"}function cropImage(e,n,o,s,l,f){var p=null;if(!s){s=e.split("?",2)[0];s=s.substring(s.lastIndexOf("/")+1)}if(l==null)l=200;if(f==null)f=l;$("#fileupload").fileupload({url:e,dataType:"json",done:function(e,a){var r=a.result;if(r.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:r.Info,time:5e3,sticky:false,class_name:r.Code==1?"success":"error"})}var i=function(){p.destroy();$(".crop-image").empty();p=null};if(p)i();$.each(r.Data.files,function(e,a){$(o).val(a);$(".crop-image").html('<img src="'+a+"?_="+Math.random()+'" />');$("#progress").fadeOut();$("#save-image").data("image-file",a);var t=$(".crop-image img");t.off().on("load",function(){App.getImgNaturalDimensions(t[0],function(e){var a=1;if(e.w>0){a=t.width()/e.w}var r=l*a,i=f*a;t.Jcrop({aspectRatio:l/f,setSelect:[0,0,r,i]},function(){p=this})})})});if(typeof $.fn.niftyModal!="undefined"){$("#crop-image").niftyModal("show",{afterClose:i})}else{$("#crop-image").modal("show");$("#crop-image").off("hide.bs.modal").on("hide.bs.modal",function(){i()})}},progressall:function(e,a){var r=parseInt(a.loaded/a.total*100,10);$("#progress").fadeIn();$("#progress").css("width",r+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled");$("#save-image").on("click",function(){var t=$(this),o=$(".crop-image img");App.getImgNaturalDimensions(o[0],function(e){var a=p.tellSelect();if(a.w!=0){var r=e.w/o.width();var i=t.data("image-file");$.get(getCropServerURL(),{src:i,x:a.x*r,y:a.y*r,w:a.w*r,h:a.h*r,type:s,size:l+"x"+f},function(e){if(e.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:e.Info,time:5e3,sticky:false,class_name:e.Code==1?"success":"error"})}$(".profile-avatar").attr("src",e.Data+"?_="+Math.random());$(n).val(e.Data);if(typeof $.fn.niftyModal!="undefined"){$("#crop-image").niftyModal("hide")}else{$("#crop-image").modal("hide")}p.destroy();$(".crop-image").empty();p=null},"json")}else{alert("Please select a crop region then press save.")}})});$(".avatar-upload .avatar-remove").on("click",function(){$(".profile-avatar").attr("src","");$(o).val("");$(n).val("")})}