function getCropServerURL(){if(typeof window.CropServerURL!="undefined"&&window.CropServerURL){return window.CropServerURL}if(typeof window.IS_BACKEND!="undefined"&&window.IS_BACKEND){return BACKEND_URL+"/manager/crop"}return FRONTEND_URL+"/user/file/crop"}function cropImage(e,i,a,t,r,p){var o={uploadURL:e,croperURL:getCropServerURL(),fileElem:null,thumbsnailInput:i,originalInput:a,previewElem:null,type:t,width:r,height:p,prefix:"noprefix"};if(typeof e=="object"){o=$.extend(o,e)}else{o.fileElem="#fileupload"}if(!o.fileElem){o.fileElem="#"+o.prefix+"-fileupload"}else{o.prefix=$(o.fileElem).data("prefix")||"noprefix"}if(!o.thumbsnailInput){o.thumbsnailInput=$(o.fileElem).data("thumbsnail-input")||"#"+o.prefix+"-image"}if(!o.originalInput){o.originalInput=$(o.fileElem).data("original-input")||"#"+o.prefix+"-image-original"}if(!o.previewElem){o.previewElem=$(o.fileElem).data("preview")||"";if(!o.previewElem)o.previewElem=$(o.fileElem).siblings("img")[0]}if(!o.type){o.type=$(o.fileElem).data("type")||"";if(!o.type){o.type=o.uploadURL.split("?",2)[0];o.type=o.type.substring(o.type.lastIndexOf("/")+1)}}if(o.width==null){o.width=$(o.fileElem).data("width")||200}if(o.height==null){o.height=$(o.fileElem).data("height")||o.width}var f=$("#"+o.prefix+"-crop-image"),l=$("#"+o.prefix+"-progress"),n=$("#"+o.prefix+"-save-image"),r=o.width,p=o.height;var s=null;var d=function(l){App.getImgNaturalDimensions(l[0],function(e){var i=1;if(e.w>0){i=l.width()/e.w}var a=r*i,t=p*i;l.Jcrop({aspectRatio:r/p,setSelect:[0,0,a,t]},function(){s=this})})};var u=function(e,i){var a=function(){s.destroy();f.find(".crop-image").empty();s=null};if(s)a();$.each(e,function(e,i){$(o.originalInput).val(i);f.find(".crop-image").html('<img src="'+i+"?_="+Math.random()+'" />');l.fadeOut();n.data("image-file",i);var a=f.find(".crop-image img");a.off().on("load",function(){d(a)})});if(typeof $.fn.niftyModal!="undefined"){f.niftyModal("show",{afterClose:a})}else{f.modal("show");f.off("hide.bs.modal").on("hide.bs.modal",function(){a()})}};$(o.fileElem).fileupload({url:o.uploadURL,dataType:"json",done:function(e,i){var a=i.result;if(a.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:a.Info,time:5e3,sticky:false,class_name:a.Code==1?"success":"error"})}n.data("type",o.type);u(a.Data.files)},progressall:function(e,i){var a=parseInt(i.loaded/i.total*100,10);l.fadeIn();l.css("width",a+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled");n.on("click",function(){var l=$(this),n=f.find(".crop-image img");App.getImgNaturalDimensions(n[0],function(e){var i=s.tellSelect();if(i.w!=0){var a=e.w/n.width();var t=l.data("image-file");$.get(o.croperURL,{src:t,x:i.x*a,y:i.y*a,w:i.w*a,h:i.h*a,type:l.data("type")||o.type,size:r+"x"+p},function(e){if(e.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:e.Info,time:5e3,sticky:false,class_name:e.Code==1?"success":"error"})}$(o.previewElem).attr("src",e.Data+"?_="+Math.random());$(o.thumbsnailInput).val(e.Data);if(typeof $.fn.niftyModal!="undefined"){f.niftyModal("hide")}else{f.modal("hide")}s.destroy();f.find(".crop-image").empty();s=null},"json")}else{alert("Please select a crop region then press save.")}})});var m=$(o.fileElem).siblings(".avatar-actions");if(m.length<1){m=$('<div class="avatar-actions"></div');$(o.fileElem).parent("div").prepend(m)}var c=m.children(".avatar-remove");if(c.length<1){c=$('<a class="label label-danger avatar-remove" href="javascript:;" title="'+App.t("删除图片")+'"><i class="fa fa-times"></i></a>');m.append(c)}c.on("click",function(){$(o.previewElem).attr("src",ASSETS_URL+"/images/user_128.png");$(o.originalInput).val("");$(o.thumbsnailInput).val("")});if(typeof App.editor=="undefined"){return}var g=$('<a class="label label-primary avatar-browsing" href="javascript:;" title="'+App.t("从服务器选择")+'"><i class="fa fa-folder-open-o"></i></a>');m.append(g);g.on("click",function(){App.editor.finderDialog(App.editor.browsingFileURL+"?from=parent&size=12&filetype=image&multiple=0",function(e,i){if(e.length<=0){return App.message({type:"error",text:App.t("没有选择任何选项！")})}var a=i[0];n.data("type",a.table_name+"."+a.field_name);u([e[0]])},1e5)})}