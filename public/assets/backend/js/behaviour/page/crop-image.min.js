function getCropServerURL(){if(typeof window.CropServerURL!="undefined"&&window.CropServerURL){return window.CropServerURL}if(typeof window.IS_BACKEND!="undefined"&&window.IS_BACKEND){return BACKEND_URL+"/manager/crop"}return FRONTEND_URL+"/user/file/crop"}function cropImage(e,i,a,t,o,f){var s={uploadURL:e,croperURL:getCropServerURL(),fileElem:null,thumbsnailInput:i,originalInput:a,previewElem:null,type:t,width:o,height:f,prefix:"noprefix"};if(typeof e=="object"){s=$.extend(s,e)}else{s.fileElem="#fileupload"}if(!s.fileElem){s.fileElem="#"+s.prefix+"-fileupload"}else{s.prefix=$(s.fileElem).data("prefix")||"noprefix"}if(!s.thumbsnailInput){s.thumbsnailInput=$(s.fileElem).data("thumbsnail-input")||"#"+s.prefix+"-image"}if(!s.originalInput){s.originalInput=$(s.fileElem).data("original-input")||"#"+s.prefix+"-image-original"}if(!s.previewElem){s.previewElem=$(s.fileElem).data("preview")||"";if(!s.previewElem)s.previewElem=$(s.fileElem).siblings("img")[0]}if(!s.type){s.type=$(s.fileElem).data("type")||"";if(!s.type){s.type=s.uploadURL.split("?",2)[0];s.type=s.type.substring(s.type.lastIndexOf("/")+1)}}if(s.width==null){s.width=$(s.fileElem).data("width")||200}if(s.height==null){s.height=$(s.fileElem).data("height")||s.width}var d=$("#"+s.prefix+"-crop-image"),r=$("#"+s.prefix+"-progress"),n=$("#"+s.prefix+"-save-image"),o=s.width,f=s.height;var u=null;var l=function(r){App.getImgNaturalDimensions(r[0],function(e){var i=1;if(e.w>0){i=r.width()/e.w}var a=o*i,t=f*i;r.Jcrop({aspectRatio:o/f,setSelect:[0,0,a,t]},function(){u=this})})};var p=function(e,i){var a=function(){u.destroy();d.find(".crop-image").empty();u=null};if(u)a();$.each(e,function(e,i){$(s.originalInput).val(i);d.find(".crop-image").html('<img src="'+i+"?_="+Math.random()+'" />');r.fadeOut();n.data("image-file",i);var a=d.find(".crop-image img");a.off().on("load",function(){l(a)})});if(typeof $.fn.niftyModal!="undefined"){d.niftyModal("show",{afterClose:a})}else{d.modal("show");d.off("hide.bs.modal").on("hide.bs.modal",function(){a()})}};$(s.fileElem).fileupload({url:s.uploadURL,dataType:"json",done:function(e,i){var a=i.result;if(a.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:a.Info,time:5e3,sticky:false,class_name:a.Code==1?"success":"error"})}n.data("type",s.type);p(a.Data.files)},progressall:function(e,i){var a=parseInt(i.loaded/i.total*100,10);r.fadeIn();r.css("width",a+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled");var m=$(s.fileElem).siblings(".avatar-actions");if(m.length<1){m=$('<div class="avatar-actions"></div');$(s.fileElem).parent("div").prepend(m)}n.on("click",function(){var l=$(this),p=d.find(".crop-image img");App.getImgNaturalDimensions(p[0],function(e){var i=u.tellSelect();if(i.w!=0){var a=e.w/p.width();var t=l.data("image-file");var r=m.children(".avatar-resize").data("token");var n={src:t,x:i.x*a,y:i.y*a,w:i.w*a,h:i.h*a,type:l.data("type")||s.type,size:o+"x"+f};if(r!==undefined&&r)n.token=r;$.get(s.croperURL,n,function(e){if(e.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:e.Info,time:5e3,sticky:false,class_name:e.Code==1?"success":"error"})}$(s.previewElem).attr("src",e.Data+"?_="+Math.random());$(s.thumbsnailInput).val(e.Data);if(typeof $.fn.niftyModal!="undefined"){d.niftyModal("hide")}else{d.modal("hide")}u.destroy();d.find(".crop-image").empty();u=null},"json")}else{alert("Please select a crop region then press save.")}})});var c=m.children(".avatar-remove");if(c.length<1){c=$('<a class="label label-danger avatar-remove" href="javascript:;" title="'+App.t("删除图片")+'"><i class="fa fa-times"></i></a>');m.append(c)}c.on("click",function(){$(s.previewElem).attr("src",ASSETS_URL+"/images/user_128.png");$(s.originalInput).val("");$(s.thumbsnailInput).val("");m.children(".avatar-resize").hide()});if(typeof App.editor=="undefined"){return}var v=$('<a class="label label-primary avatar-browsing" href="javascript:;" title="'+App.t("从服务器选择")+'"><i class="fa fa-folder-open-o"></i></a>');m.append(v);var g=m.children(".avatar-resize");if(g.length<1){g=$('<a class="label label-warning avatar-resize" href="javascript:;" title="'+App.t("裁剪图片")+'" style="display:none"><i class="fa fa-crop"></i></a>');m.append(g)}v.on("click",function(){App.editor.finderDialog(App.editor.browsingFileURL+"?from=parent&size=12&filetype=image&multiple=0",function(a,e){if(a.length<=0){return App.message({type:"error",text:App.t("没有选择任何选项！")})}var i=e[0];n.data("type",i.table_name+"."+i.field_name);$.post(s.uploadURL,{pipe:"_queryThumb",file:a[0],size:o+"x"+f},function(e){if(e.Code!=1)return App.message({type:"error",text:e.Info});if("thumb"in e.Data){var i=e.Data.thumb;$(s.previewElem).attr("src",i+"?_="+Math.random());$(s.thumbsnailInput).val(i);m.children(".avatar-resize").data("token",e.Data.token).show();return}p([a[0]])},"json")},1e5)});g.on("click",function(){var e=$(s.originalInput).val();if(!e)return App.message({type:"error",text:App.t("请先选择图片！")});p([e])})}