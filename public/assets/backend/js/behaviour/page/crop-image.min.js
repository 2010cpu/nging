if(typeof window.CropServerURL=="undefined"){window.CropServerURL=BACKEND_URL+"/manager/crop"}else{window.CropServerURL=window.CropServerURL||BACKEND_URL+"/manager/crop"}function cropImage(e,n,t,s,l,p){var f=null;if(!s){s=e.split("?",2)[0];s=s.substring(s.lastIndexOf("/")+1)}if(l==null)l=200;if(p==null)p=l;$("#fileupload").fileupload({url:e,dataType:"json",done:function(e,a){var i=a.result;if(i.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:i.Info,time:5e3,sticky:false,class_name:i.Code==1?"success":"error"})}var o=function(){f.destroy();$(".crop-image").empty();f=null};if(f)o();$.each(i.Data.files,function(e,a){$(t).val(a);$(".crop-image").html('<img src="'+a+"?_="+Math.random()+'" />');$("#progress").fadeOut();$("#save-image").data("image-file",a);var r=$(".crop-image img");r.off().on("load",function(){App.getImgNaturalDimensions(r[0],function(e){var a=1;if(e.w>0){a=r.width()/e.w}var i=l*a,o=p*a;r.Jcrop({aspectRatio:l/p,minSize:[i,o],setSelect:[0,0,i,o]},function(){f=this})})})});if(typeof $.fn.niftyModal!="undefined"){$("#crop-image").niftyModal("show",{afterClose:o})}else{$("#crop-image").modal("show");$("#crop-image").off("hide.bs.modal").on("hide.bs.modal",function(){o()})}},progressall:function(e,a){var i=parseInt(a.loaded/a.total*100,10);$("#progress").fadeIn();$("#progress").css("width",i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled");$("#save-image").on("click",function(){var r=$(this),t=$(".crop-image img");App.getImgNaturalDimensions(t[0],function(e){var a=f.tellSelect();if(a.w!=0){var i=e.w/t.width();var o=r.data("image-file");$.get(window.CropServerURL,{src:o,x:a.x*i,y:a.y*i,w:a.w*i,h:a.h*i,type:s,size:l+"x"+p},function(e){if(e.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:e.Info,time:5e3,sticky:false,class_name:e.Code==1?"success":"error"})}$(".profile-avatar").attr("src",e.Data+"?_="+Math.random());$(n).val(e.Data);if(typeof $.fn.niftyModal!="undefined"){$("#crop-image").niftyModal("hide")}else{$("#crop-image").modal("hide")}f.destroy();$(".crop-image").empty();f=null},"json")}else{alert("Please select a crop region then press save.")}})});$(".avatar-upload .avatar-remove").on("click",function(){$(".profile-avatar").attr("src","");$(t).val("");$(n).val("")})}